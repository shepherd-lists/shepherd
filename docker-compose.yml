version: '3.7'

services:
  scanner:
    hostname: ${IMAGE_REPO:-dummy}-shepherd-scanner
    build: 
      context: ./apps
      target: scanner
    environment: 
      DB_HOST: ${DB_HOST:-pgdb}
      PROCESS_NAME: scanner
      SLACK_WEBHOOK: ${SLACK_WEBHOOK}
    restart: always
  webserver:
    build: 
      context: ./apps
      target: web
    environment: 
      DB_HOST: ${DB_HOST:-pgdb}
      PROCESS_NAME: webserver
      SLACK_WEBHOOK: ${SLACK_WEBHOOK:-}
    ports: 
      - '80:80'
    restart: always
    depends_on:
      - scanner
  http-api:
    build: 
      context: ./apps
      target: web
    environment: 
      DB_HOST: ${DB_HOST:-pgdb}
      PROCESS_NAME: http-api
      SLACK_WEBHOOK: ${SLACK_WEBHOOK}
    # ports: 
    #   - '84:84'
    restart: always
    depends_on:
      - scanner
  rating:
    hostname: ${IMAGE_REPO:-dummy}-shepherd-rating
    build: 
      context: ./apps
      target: rating
    environment: 
      DB_HOST: ${DB_HOST:-pgdb}
      PROCESS_NAME: rating
      SLACK_WEBHOOK: ${SLACK_WEBHOOK:-}
      NODE_OPTIONS: '--max-old-space-size=8192'
      TF_ENABLE_ONEDNN_OPTS: '1'
    restart: always
    depends_on:
      - scanner