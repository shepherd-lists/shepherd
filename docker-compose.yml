version: '3.9'

services:
  pgmigrate:
    build:
      context: ./postgres.migrate
    environment:
      DB_HOST: ${DB_HOST-pgdb}
    volumes:
      - ./postgres.migrate:/app
    # restart: 'no'
    deploy:
      restart_policy:
        condition: 'any'
        max_attempts: 0
  webserver:
    build: 
      context: .
      target: ${TARGET:-prod}
    environment: 
      DB_HOST: ${DB_HOST:-pgdb}
      PROCESS_NAME: webserver
    ports: 
      - '80:80'
    restart: always
  http-api:
    build: 
      context: .
      target: ${TARGET:-prod}
    environment: 
      DB_HOST: ${DB_HOST:-pgdb}
      PROCESS_NAME: http-api
    ports: 
      - '84:84'
    restart: always
  scanner:
    hostname: ${IMAGE_REPO:-dummy}-shepherd-scanner
    build: 
      context: .
    environment: 
      DB_HOST: ${DB_HOST:-pgdb}
      PROCESS_NAME: scanner
    restart: always
  rating:
    hostname: ${IMAGE_REPO:-dummy}-shepherd-rating
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 30G
    build: 
      context: .
    environment: 
      DB_HOST: ${DB_HOST:-pgdb}
      PROCESS_NAME: rating
      NODE_OPTIONS: '--max-old-space-size=8192'
    restart: always